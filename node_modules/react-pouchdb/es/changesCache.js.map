{"version":3,"sources":["../src/changesCache.js"],"names":["stringify","get","cache","EVENT","changesCache","options","handleChange","dbCache","key","listener","eventEmitter","changes","count","on","cancel","removeListener","delete"],"mappings":";AAAA,OAAOA,SAAP,MAAsB,uBAAtB;AACA,OAAOC,GAAP,MAAgB,uBAAhB;AAEA,OAAO,IAAMC,QAAQ,UAAd;AAEP,IAAMC,QAAQ,QAAd;AAEA,eAAe,SAASC,YAAT,CAAsBC,OAAtB,EAA+BC,YAA/B,EAA6C;AAAA;;AAC1D,MAAMC,UAAiBN,GAAP,aAAW,IAAX,EAAiB;AAAA,WAAM,UAAN;AAAA,GAAjB,CAAhB;AACA,MAAMO,MAAMR,UAAUK,OAAV,CAAZ;AACA,MAAMI,WAAoBR,GAAT,eAAaO,GAAb,EAAkB;AAAA,WAAO;AACxCE,oBAAc,MAAKC,OAAL,CAAaN,OAAb,CAD0B;AAExCO,aAAO;AAFiC,KAAP;AAAA,GAAlB,CAAjB;AAH0D,MAOlDF,YAPkD,GAOjCD,QAPiC,CAOlDC,YAPkD;AAQ1DD,WAASG,KAAT,GAAiBH,SAASG,KAAT,GAAiB,CAAlC;AACAF,eAAaG,EAAb,CAAgBV,KAAhB,EAAuBG,YAAvB;AACA,SAAO,SAASQ,MAAT,GAAkB;AACvBL,aAASG,KAAT,GAAiBH,SAASG,KAAT,GAAiB,CAAlC;;AACA,QAAIH,SAASG,KAAb,EAAoB;AAClBF,mBAAaK,cAAb,CAA4BZ,KAA5B,EAAmCG,YAAnC;AACD,KAFD,MAEO;AACLI,mBAAaI,MAAb;AACAP,cAAQS,MAAR,CAAeR,GAAf;AACD;AACF,GARD;AASD","sourcesContent":["import stringify from 'json-stable-stringify';\nimport get from './getWithDefaultValue';\n\nexport const cache = new Map();\n\nconst EVENT = 'change';\n\nexport default function changesCache(options, handleChange) {\n  const dbCache = cache::get(this, () => new Map());\n  const key = stringify(options);\n  const listener = dbCache::get(key, () => ({\n    eventEmitter: this.changes(options),\n    count: 0\n  }));\n  const { eventEmitter } = listener;\n  listener.count = listener.count + 1;\n  eventEmitter.on(EVENT, handleChange);\n  return function cancel() {\n    listener.count = listener.count - 1;\n    if (listener.count) {\n      eventEmitter.removeListener(EVENT, handleChange);\n    } else {\n      eventEmitter.cancel();\n      dbCache.delete(key);\n    }\n  };\n}\n"],"file":"changesCache.js"}