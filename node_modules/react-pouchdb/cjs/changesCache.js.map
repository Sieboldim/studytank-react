{"version":3,"sources":["../src/changesCache.js"],"names":["cache","EVENT","changesCache","options","handleChange","dbCache","get","key","listener","eventEmitter","changes","count","on","cancel","removeListener","delete"],"mappings":";;;;;;;;;;;;AAAA;;AACA;;AAEO,IAAMA,QAAQ,kBAAd;;AAEP,IAAMC,QAAQ,QAAd;;AAEe,SAASC,YAAT,CAAsBC,OAAtB,EAA+BC,YAA/B,EAA6C;AAAA;;AAC1D,MAAMC,UAAiBC,4BAAP,aAAW,IAAX,EAAiB;AAAA,WAAM,kBAAN;AAAA,GAAjB,CAAhB;;AACA,MAAMC,MAAM,kCAAUJ,OAAV,CAAZ;;AACA,MAAMK,WAAoBF,4BAAT,eAAaC,GAAb,EAAkB;AAAA,WAAO;AACxCE,oBAAc,MAAKC,OAAL,CAAaP,OAAb,CAD0B;AAExCQ,aAAO;AAFiC,KAAP;AAAA,GAAlB,CAAjB;;AAH0D,MAOlDF,YAPkD,GAOjCD,QAPiC,CAOlDC,YAPkD;AAQ1DD,WAASG,KAAT,GAAiBH,SAASG,KAAT,GAAiB,CAAlC;AACAF,eAAaG,EAAb,CAAgBX,KAAhB,EAAuBG,YAAvB;AACA,SAAO,SAASS,MAAT,GAAkB;AACvBL,aAASG,KAAT,GAAiBH,SAASG,KAAT,GAAiB,CAAlC;;AACA,QAAIH,SAASG,KAAb,EAAoB;AAClBF,mBAAaK,cAAb,CAA4Bb,KAA5B,EAAmCG,YAAnC;AACD,KAFD,MAEO;AACLK,mBAAaI,MAAb;AACAR,cAAQU,MAAR,CAAeR,GAAf;AACD;AACF,GARD;AASD","sourcesContent":["import stringify from 'json-stable-stringify';\nimport get from './getWithDefaultValue';\n\nexport const cache = new Map();\n\nconst EVENT = 'change';\n\nexport default function changesCache(options, handleChange) {\n  const dbCache = cache::get(this, () => new Map());\n  const key = stringify(options);\n  const listener = dbCache::get(key, () => ({\n    eventEmitter: this.changes(options),\n    count: 0\n  }));\n  const { eventEmitter } = listener;\n  listener.count = listener.count + 1;\n  eventEmitter.on(EVENT, handleChange);\n  return function cancel() {\n    listener.count = listener.count - 1;\n    if (listener.count) {\n      eventEmitter.removeListener(EVENT, handleChange);\n    } else {\n      eventEmitter.cancel();\n      dbCache.delete(key);\n    }\n  };\n}\n"],"file":"changesCache.js"}